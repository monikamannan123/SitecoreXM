name: Sitecore 1041 XM provison

on:
 push:
     branches:
      - main
permissions:
  contents: read
  actions: write      

jobs:
  build:
    uses: ./.github/workflows/newCI.yml   # call reusable workflow
    
    
  upload:
    needs: [build]
    runs-on: windows-latest
    env:
      buildArtifactRootDirectory: 'Sitecore10.4.1-XMScaled-CI'
      dropFolderName: 'drop'
      sclicenseblobname: 'license.xml'
      sqlServerLogin: 'sqladminlogin'
      solrURL: 'https://localhost:8983/solr'
      PaaSLocation: eastus2
      DeploymentID: dpsitecore1041
      Sitecore_RG: ${{ secrets.RESOURCEGROUP_NAME }}
      #storageaccount_token: ${{ secrets.STORAGE_ACCOUNT_KEY }}
      BUILD_ARTIFACT_ROOT: Sitecore10.4.1-XMScaled-CI
      DROP_FOLDER: drop
      LICENSE_BLOB_NAME: license.xml
      STORAGE_RG: ${{ secrets.RESOURCEGROUP_NAME }}
      #STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
      STORAGE_ACCOUNT_NAME: storageacctxmgithub
      #STORAGE_CONTAINER: ${{ secrets.STORAGE_CONTAINER }}
      STORAGE_CONTAINER: containergithub
      KEYVAULT_NAME: ${{ secrets.KEYVAULT_NAME }}
      CERT_PASSWORD_SECRET: certPassword123
      CERT_NAME: gitcert101
      AZURE_SUBSCRIPTION: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Set storage account URL in env
        run: |
          echo "STORAGE_ACCOUNT_URI=https://storageacctxmgithub.blob.core.windows.net/containergithub" >> $GITHUB_ENV


      - name: Show URL
        run: |
          echo "Storage URL: $env:STORAGE_ACCOUNT_URI"
      - name: Connect Az PowerShell
        shell: pwsh
        run: |
          $clientId     = "${{ secrets.AZURE_CLIENT_ID }}"
          $clientSecret = "${{ secrets.AZURE_CLIENT_SECRET }}"
          $tenantId     = "${{ secrets.AZURE_TENANT_ID }}"
          $subscription = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
      
          $secureSecret = ConvertTo-SecureString $clientSecret -AsPlainText -Force
          $cred         = New-Object System.Management.Automation.PSCredential($clientId, $secureSecret)
      
          Connect-AzAccount -ServicePrincipal -Tenant $tenantId -Credential $cred
          Set-AzContext -Subscription $subscription
      
      - name: Download artifact:drop
        uses: actions/download-artifact@v4
        with:
          name: drop
          path: ${{ github.workspace }}/drop
      
      - name: Upload Sitecore packages to Blob
        run: |
           az storage blob upload-batch `
           --account-name $env:STORAGE_ACCOUNT_NAME `
           --account-key $env:STORAGE_ACCOUNT_KEY `
           --destination containergithub/xmscaled `
           --source "$env:GITHUB_WORKSPACE\drop"

       # Generate SAS token and Blob URI
      
      - name: Generate SAS Token for container
        shell: bash
        run: |
           # Set start time (15 minutes ago) and expiry (8 hours from now)
           start=$(date -u -d "-15 minutes" '+%Y-%m-%dT%H:%M:%SZ')
           expiry=$(date -u -d "+8 hours" '+%Y-%m-%dT%H:%M:%SZ')
       
           # Generate SAS token for the container with explicit version
           sas=$(az storage container generate-sas \
             --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} \
             --name ${{ secrets.STORAGE_CONTAINER }} \
             --account-key ${{ secrets.STORAGE_ACCOUNT_KEY }} \
             --permissions rlacwd \
             --https-only \
             --start $start \
             --expiry $expiry -o tsv)
       
           echo "storageaccount_token=$sas" >> $GITHUB_ENV
           echo "STORAGE_ACCOUNT_URI=https://${{ secrets.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/${{ secrets.STORAGE_CONTAINER }}" >> $GITHUB_ENV


      # Example usage of SAS token in later steps
      - name: Show SAS Outputs
        run: |
          echo "Blob URI: ${{ steps.sas.outputs.blobUri }}"
          echo "SAS Token: ${{ steps.sas.outputs.sasToken }}"
          # Step 1: Download Azure Toolkit from blob (inline script)
          
      - name: Download Azure Toolkit from blob
        shell: pwsh
        run: |
           $ResourceGroupName  = $env:STORAGE_RG
           $StorageAccountName = $env:STORAGE_ACCOUNT_NAME
           $ContainerName      = $env:STORAGE_CONTAINER
           $Prefix             = "azuretoolkit"
           $Destination        = "${{ github.workspace }}"
       
           Write-Host "Downloading blobs with prefix '$Prefix' from container '$ContainerName' in storage account '$StorageAccountName'"
       
           $storageAcc = Get-AzStorageAccount -ResourceGroupName $ResourceGroupName -Name $StorageAccountName
           $ctx        = $storageAcc.Context
       
           $blobs = Get-AzStorageBlob -Container $ContainerName -Context $ctx | Where-Object { $_.Name -like "$Prefix*" }
       
           if (-not $blobs) {
             Write-Error "No blobs found with prefix $Prefix in container $ContainerName"
             exit 1
           }
       
           if (-not (Test-Path $Destination)) {
             New-Item -ItemType Directory -Force -Path $Destination | Out-Null
           }
       
           foreach ($blob in $blobs) {
             Write-Host "Downloading blob: $($blob.Name)"
             Get-AzStorageBlobContent -Container $ContainerName -Context $ctx -Blob $blob.Name -Destination $Destination -Force
           }
       
           Write-Host "Download complete. Files saved to $Destination"

     # Step 1: Download Azure Toolkit from blob
      #- name: Download Azure Toolkit from blob
        #shell: pwsh
       # run: |
          
          #$scriptPath = Join-Path "${{ github.workspace }}/drop/Scripts" "DownloadCOntainerFolders.ps1"
          #$scriptPath = "${{ github.workspace }}/Sitecore10.4.1-XMScaled-CI/drop/DownloadCOntainerFolders.ps1"
          #$args = "-ResourceGroupName $env:STORAGE_RG -StorageAccountName $env:STORAGE_ACCOUNT_NAME -ContainerName $env:STORAGE_CONTAINER -Prefix azuretoolkit -Destination ${{ github.workspace }}"
         # Write-Host "Running script: $scriptPath $args"
          #& $scriptPath $args

      # Step 2: Extract toolkit zip files
      - name: Extract files
        shell: pwsh
        run: |
          $archivePath = "${{ github.workspace }}\azuretoolkit\*.zip"
          $destination = "${{ github.workspace }}\blob"
          Write-Host "Extracting $archivePath to $destination"
          New-Item -ItemType Directory -Force -Path $destination | Out-Null
          Get-ChildItem $archivePath | ForEach-Object {
            Expand-Archive -Path $_.FullName -DestinationPath $destination -Force
          }
      
      - name: Download Certificate from KeyVault
        shell: pwsh
        run: |
          $vaultName   = "$env:KEYVAULT_NAME"
          $secretName  = "$env:CERT_PASSWORD_SECRET"

          # Get certificate password from Key Vault secret
          $secret      = Get-AzKeyVaultSecret -VaultName $vaultName -Name $secretName
          $bstr        = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($secret.SecretValue)
          $plaintext   = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($bstr)
          $certPassword = $plaintext

          # Get certificate from Key Vault
          $cert        = Get-AzKeyVaultCertificate -VaultName $vaultName -Name $env:CERT_NAME
          $secret      = Get-AzKeyVaultSecret -VaultName $vaultName -Name $cert.Name

          $secretValueText = ''
          $ssPtr           = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($secret.SecretValue)
          try {
              $secretValueText = [System.Runtime.InteropServices.Marshal]::PtrToStringBSTR($ssPtr)
          } finally {
              [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($ssPtr)
          }

          # Convert secret to certificate
          $secretByte   = [Convert]::FromBase64String($secretValueText)
          $x509Cert     = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($secretByte, "", "Exportable,PersistKeySet")
          $type         = [System.Security.Cryptography.X509Certificates.X509ContentType]::Pfx
          $pfxFileByte  = $x509Cert.Export($type, $certPassword)

          # Write to file
          $exportPath = "${{ github.workspace }}\$env:BUILD_ARTIFACT_ROOT\$env:DROP_FOLDER\ExportedCert.pfx"
          New-Item -ItemType Directory -Force -Path (Split-Path $exportPath) | Out-Null
          [System.IO.File]::WriteAllBytes($exportPath, $pfxFileByte)

          Write-Host "Certificate exported to: $exportPath"
      - name: Show drop folder tree
        shell: pwsh
        run: |
              $dropFolderPath    = Join-Path $env:GITHUB_WORKSPACE "Sitecore10.4.1-XMScaled-CI\drop"
              Get-ChildItem "$env:GITHUB_WORKSPACE\drop" -Recurse | 
                Sort-Object FullName | 
                ForEach-Object { $_.FullName }   
                Get-ChildItem $dropFolderPath -Recurse
      - name: Install Sitecore1041PaaS
        shell: pwsh
        run: |
           # ---------------------------
           # VARIABLES
           # ---------------------------
           $DeploymentID      = $env:DeploymentID
           $dropFolderPath    = Join-Path $env:GITHUB_WORKSPACE "Sitecore10.4.1-XMScaled-CI\drop"
           $LicenseFile       = Join-Path $env:GITHUB_WORKSPACE "drop\Scripts\license.xml"
           $Location          = $env:PaaSLocation
           $sqlServerLogin    = $env:sqlServerLogin
           
           $ExportedCert = Join-Path $dropFolderPath "ExportedCert.pfx"
           if (-not (Test-Path $ExportedCert)) {
             Write-Error "ExportedCert NOT FOUND at $ExportedCert"
             exit 1
           }
       
           $ParamFile         = Join-Path $env:GITHUB_WORKSPACE "drop\azuredeploy.parameters.json"
       
           if (-not (Test-Path $LicenseFile)) {
             Write-Error "Sitecore license file not found at $LicenseFile"
             exit 1
           }
       
           Write-Host "==== PARAMETER FILE CONTENT ===="
           Get-Content -Path $ParamFile
       
       
           # ---------------------------
           # FIX STORAGE URI + TOKEN
           # ---------------------------
       
           # Ensure storage URI ALWAYS ends without double slashes
           $StorageBase = $env:STORAGE_ACCOUNT_URI.TrimEnd('/')
       
           # Ensure SAS token never has leading '?'
           $SasToken = $env:storageaccount_token.TrimStart('?').Trim('"')
       
       
           # ---------------------------
           # TEMPLATE URLS
           # ---------------------------
           $TemplateUrl             = "$StorageBase/xmscaled/arm/azuredeploy.json?$SasToken"
           $TemplateLinkBase        = "$StorageBase/xmscaled/arm/"
           $TemplateLinkAccessToken = "?$SasToken"
       
           Write-Host "TemplateUrl: $TemplateUrl"
           Write-Host "TemplateLinkBase: $TemplateLinkBase"
           Write-Host "TemplateLinkAccessToken: $TemplateLinkAccessToken"
           Write-Host "Storage URI: $StorageBase"
       
       
           # ---------------------------
           # PACKAGE URLS
           # ---------------------------
           $solrConnectionString    = $env:solrURL
           $siMsDeployPackageUrl = "$StorageBase/xmscaled/arm/Sitecore.IdentityServer.8.0.28.scwdp.zip?$SasToken"
           $cdMsDeployPackageUrl = "$StorageBase/xmscaled/arm/Sitecore.XM10.4.1.cd.scwdp.zip?$SasToken"
           $cmMsDeployPackageUrl = "$StorageBase/xmscaled/arm/Sitecore.XM10.4.1.cm.scwdp.zip?$SasToken"


           #$siMsDeployPackageUrl = "$StorageBase/xmscaled/Sitecore.IdentityServer.8.0.28.scwdp.zip?$SasToken"
           #$cdMsDeployPackageUrl = "$StorageBase/xmscaled/Sitecore.XM10.4.1.cd.scwdp.zip?$SasToken"
           #$cmMsDeployPackageUrl = "$StorageBase/xmscaled/Sitecore.XM10.4.1.cm.scwdp.zip?$SasToken"
       
           Write-Host "siMsDeployPackageUrl: $siMsDeployPackageUrl"
           Write-Host "cmMsDeployPackageUrl: $cmMsDeployPackageUrl"
           Write-Host "cdMsDeployPackageUrl: $cdMsDeployPackageUrl"
       
       
           # ---------------------------
           # PARAMETER OVERRIDES  
           # ---------------------------
           $Parameters = @{
               "location"                    = $Location
               "deploymentId"                = $DeploymentID
               "templateLinkBase"            = $TemplateLinkBase
               "templateLinkAccessToken"     = $TemplateLinkAccessToken
               "sqlServerLogin"              = $sqlServerLogin
               "solrConnectionString"        = $solrConnectionString
               "siMsDeployPackageUrl"        = $siMsDeployPackageUrl
               "cdMsDeployPackageUrl"        = $cdMsDeployPackageUrl
               "cmMsDeployPackageUrl"        = $cmMsDeployPackageUrl
               "applicationInsightsLocation" = $Location
               "authCertificateBlob"         = [System.Convert]::ToBase64String([System.IO.File]::ReadAllBytes($ExportedCert))
           }
       
       
           # ---------------------------
           # START DEPLOYMENT
           # ---------------------------
           Import-Module "$env:GITHUB_WORKSPACE\blob\tools\Sitecore.Cloud.Cmdlets.psm1" -Verbose
       
           Start-SitecoreAzureDeployment `
               -Location $Location `
               -Name $env:Sitecore_RG `
               -ArmTemplateUrl $TemplateUrl `
               -ArmParametersPath $ParamFile `
               -LicenseXmlPath $LicenseFile `
               -SetKeyValue $Parameters `
               -Verbose
       
           Write-Host "===== Sitecore Deployment Complete ====="

