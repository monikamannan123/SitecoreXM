name: Sitecore 1041 XM Installation 

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Upload files to Blob
      - name: Upload Sitecore packages
        run: |
          az storage blob upload-batch `
            --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} `
            --destination ${{ secrets.STORAGE_CONTAINER }} `
            --source "${{ github.workspace }}/Sitecore10.4.1-XMScaled-CI/drop" `
            --auth-mode key `
            --account-key ${{ secrets.STORAGE_ACCOUNT_KEY }} `
            --destination-path "xmscaled/arm"

      # Generate SAS token and Blob URI
      - name: Generate SAS Token
        id: sas
        run: |
          $expiry = (Get-Date).AddHours(10).ToString("yyyy-MM-ddTHH:mm:ssZ")
          $sas = az storage account generate-sas `
            --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} `
            --account-key ${{ secrets.STORAGE_ACCOUNT_KEY }} `
            --services b `
            --resource-types sco `
            --permissions rwlac `
            --expiry $expiry `
            --https-only `
            -o tsv
          echo "sasToken=$sas" >> $env:GITHUB_OUTPUT
          $blobUri = "https://${{ secrets.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/${{ secrets.STORAGE_CONTAINER }}"
          echo "blobUri=$blobUri" >> $env:GITHUB_OUTPUT

      # Example usage of SAS token in later steps
      - name: Show SAS Outputs
        run: |
          echo "Blob URI: ${{ steps.sas.outputs.blobUri }}"
          echo "SAS Token: ${{ steps.sas.outputs.sasToken }}"
